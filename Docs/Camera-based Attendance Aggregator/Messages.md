Message descriptors
===================

This document details the message formats sent to specific topics. Each message is in BSON format

image.new
---------

Incoming images are submitted to this topic by the REST API entry point.

* The *frame concentrator* receives this message to write the image metadata its MongoDB.
* The *train data backend* receives this message and optionally saves the whole image into its MongoDB for use as train data.

```{javascript}
{
  "id": /* An GUID generated in the REST API entry point. From that point forward, this must serve a key across multiple database instances. */,
  "camera_timestamp": /* The timestamp generated by the Raspberry Pi. */,
  "camera_id": /* The identifier of the camera Raspberry Pi. */,
  "receive_timestamp": /* The timestamp generated by the REST API. */,
  "image": /* Payload bytestring. */
}
```

image.find_rects.new
--------------------

The *image processor* receives this message from the *frame concectrator* to start processing.

```{javascript}
{
  "id": /* Image GUID. */,
  "image": /* Payload bytestring. */
}
```

image.find_rects.done.{feature_name}
-------------------------------

The *image processor* sends the rects found in the image to the *frame concentrator* in bulk.

* `C`: size of the rectangle bounding box, to be decided (probably 64 pixels).

```{javascript}
{
  "id": /* Image GUID. */
  "feature_name": /* Viola--Jones cascade name. */,
  "rects_found": [
    {
      "x": /* Top left corner x coordinate. */,
      "y": /* Top left corner y coordinate. */,
      "width": /* Rectangle width. */,
      "height": /* Rectangle height. */,
      "payload": /* Cropped rectangle contents, resized to fit into a C by C bounding box. */
    },
    /* ... */
  ]
}
```

rects.new.{feature_name}
------------------------

* Each rect is send by the *frame concentrator* to the *cnn processor*. The indirection between the *image* and *cnn processors* is introduces to make sure every rectangle is processed.
* The *train data backend* receives this message and saves the rectangle to its MongoDB for use as training data.

```{javascript}
{
  "id": /* Rect ID generated by the frame concentrator. */,
  "feature_name": /* Viola--Jones cascade name. */,
  "payload": /* Cropped rectangle bytestring. */
}
```

rects.classify.done.{feature_name}
----------------------------------

The *cnn processor* send this message to the *frame concentrator*.

```{javascript}
{
  "id": /* Rect ID. */,
  "label": 0 /* or */ 1
}
```

image.faces.done
----------------

Once all rects from a given image were classified by the *cnn processor*, the *frame concentrator* send this message to the *aggregator* which calculates the room attendance based on the state in its own MongoDB.

```{javascript}
{
  "id": /* Image GUID. */,
  "camera_timestamp": /* The timestamp generated by the Raspberry Pi. */,
  "camera_id": /* The identifier of the camera Raspberry Pi. */,
  "receive_timestamp": /* The timestamp generated by the REST API. */,
  "faces_found": [
    {
      "x": /* Top left corner x coordinate. */,
      "y": /* Top left corner y coordinate. */,
      "width": /* Rectangle width. */,
      "height": /* Rectangle height. */,
      "feature_name": /* Viola--Jones cascade name. */
    },
    /* ... */
  ]
}
```
